<!DOCTYPE html>

<html lang="ja" manifest="game.appcache" style="
	height: 100%;
	user-select: none;
	-webkit-user-select: none;
">

<head>

<meta charset="utf-8">

<title>コインゲット</title>

<link rel="apple-touch-icon-precomposed" href="icon.png" />

<!-- ★ iOS や Android 用 -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="viewport" content="width=420, user-scalable=no">

<!-- ★ Windows 用 -->
<style>
@-ms-viewport { width:420px;}
body { -ms-content-zooming:none;}
</style>

</head>

<body style="
	height: 100%;
	display: flex;
	justify-content: center;
	align-items: center;
	background-color: #333333;

	font-family: 'Rounded Mplus 1c', sans-serif;
	font-size: 30px;
	font-weight: 500;
	color: #000000;
	line-height: 1.2;
	text-align: center;
">

<canvas style="
	width:400px;
	height:600px;

	user-select:none;
	-moz-user-select:none;
	-webkit-user-select:none;
	-ms-user-select:none;

	-webkit-tap-highlight-color:rgba( 0,0,0,0);

	-ms-touch-action:none;
	touch-action:none;
" id="c1"></canvas><br>

<script src="skeleton_audio.js"></script>
<script src="skeleton_touch.js"></script>

<script>

//var a, b, c; //変数を用意する。
//
//a = 100; //変数に代入する。
//b = 7;
//c = a + 3 * b;
//

var can, ctx; //変数を宣言する。

can = document.getElementById("c1");
can.width = 400;
can.height = 600;
ctx = can.getContext("2d");

var MAXTOUCH = 5;
var CAN_PINCH = false;
var REFW = 400, REFH = 600;

var ska;
var skt;

var AUDIONUM = 4;
ska = new skeleton_audio();
ska.load( "audio/se_block_coin.mp3");
ska.load( "audio/bgm_power.mp3");
ska.load( "audio/se_coin_2.mp3");
ska.load( "audio/se_jump.mp3");

skt = new skeleton_touch( can);
skt.set_mag_and_orientation( 1, 0);
function touch_event_hook(){
	if( skt.num == 1 && skt.x == skt.bx && skt.y == skt.by){
		//★ シングルタッチでかつ、動いていないタッチに限る。
		if( !ska.did_ios_start){
			ska.start_ios();
		}
	}
}

//●●●●●●●●●●


var img_cow,img_coin;
var bx, by, bvx, bvy;
var rx;
var sc;

img_cow = new Image();
img_cow.src = "image/cow.jpg"

rx = 200;

img_coin = new Image();
img_coin.src = "image/coin.jpg"

var p = new Array( 100);

var scene;
var count;

scene = 0;
count = 0;
tic();

var i;

function tic(){
	var i;

	requestAnimationFrame( tic);

	skt.pre();

	//●●●●●●●●●●

	switch( scene){
	case 0: //● ローディング画面。

		ctx.fillStyle="#0000ff";
		ctx.fillRect( 0, 0, 400, 600);

		if( ska.loaded_count == 4) scene = 1;

		break;

	case 1: //● タイトル画面。

		if( skt.start){
			//● タッチされたので、ゲーム中画面へ。
			ska.play_loop( 1);

			scene = 2;

			bx = 200;
			by = 50;
			bvx = 0;
			bvy = 7;
			for( i = 0; i < 100; i++){
				p[ i] =10;
			}
			p[ 33] = 100;
			p[ 35] = 0;
			sc = 0;
		}
		ctx.fillStyle="#000000";
		ctx.fillRect( 0, 0, 400, 600);

		ctx.fillStyle="#ff0000";
		ctx.font="60px 'Arial";
		ctx.fillText( "コインゲット ", 20, 290);
		ctx.font="30px 'Arial";
		ctx.fillText( "タッチでスタート ", 70, 350);
		break;

	case 2: //● ゲーム中画面。

		//● 背景を白でぬりつぶす。
		ctx.fillStyle="#ffffff";
		ctx.fillRect( 0, 0, 400, 600);

		//● 地面を緑で描画。
		ctx.fillStyle="#00ff00";
		ctx.fillRect( 0, 500, 400, 100);

		//● 花を黄色で描画。
		ctx.fillStyle="#ffff00";
		for( i = 0; i < 10; i++){
			ctx.fillRect( 10 + i * 40, 540-( i%2)*20, 20, 20);
		}

		//● コインを描画。
		for( i = 0; i < 100; i++){
			if( p[ i] > 0){
				var r;

				r = 7 + 0.3 * p[ i];
				ctx.drawImage( img_coin,
					20 + 40 * ( i % 10) - r,
					20 + 40 * Math.floor( i / 10) - r,
					2 * r,
					2 * r
				);
			}
		}

		//● ボールを描画。
		draw_ball( bx, by);

		//● ラケットの座標を更新。
		rx = skt.x;

		//● ラケットを水色で描画。
		ctx.fillStyle="#00ffff";
		ctx.fillRect( rx-50, 450, 100, 10);

		//● ボールの座標を更新。
		bx = bx + bvx;
		if( 400 < bx){
			//● 右の壁ではねかえる。
			bx=400;
			bvx=-bvx;
			ska.play(3);
		}
		if( bx < 0){
			//● 左の壁ではねかえる。
			bx=0;
			bvx=-bvx;
			ska.play(3);
		}

		var n; //● ← マス番号。
		n = Math.floor( bx / 40) + 10 * Math.floor( by / 40);
		if( 0 < p[ n]){
			//● ゲットした。
			sc = sc + p[ n];
			p[ n] = 0;
			ska.play(2);
		}

		//● ボールの座標を更新。
		by = by + bvy;

		//● ラケットとの当たり判定。
		if( by > 455 && by - bvy <= 455){
			var t;
			t = ( bx - rx) / 50;
			if( -1 <= t && t <= 1){
				//● 当たった。
				ska.play( 0);

				by=455;
				bvx=5*t;
				bvy=-bvy;
			}
		}

		if( by < 0){
			//● 天井ではねかえる。
			by=0;
			bvy=-bvy;
		}

		if( by > 600) {
			scene = 3; //● ボールが落ちたので、ゲームオーバー画面へ。
			ska.stop(1);
		}
		//● スコアを描画。
		ctx.fillStyle="#ff0000";
		ctx.font="30px 'Arial";
		ctx.fillText( "score " + sc, 10, 590);

		break;

	case 3: //● ゲームオーバー画面。

		if( skt.start) scene = 1; //● タッチされたので、タイトル画面へ。

		//● 背景を赤で塗りつぶす。
		ctx.fillStyle="#ff0000";
		ctx.fillRect( 0, 0, 400, 600);

		//● 黒で「ゲームオーバー」と書く。
		ctx.fillStyle="#000000";
		ctx.font="55px 'Arial";
		ctx.fillText( "ゲームオーバー ", 20, 290);
		break;
	}

	skt.post();

	count++;
}

function draw_ball( x, y){
	ctx.drawImage( img_cow, x-25, y-25, 50, 50);
}

</script>


</body>

</html>
